<?php
include_once(".htconnection.php");
require_once('PHPExcel.php');

function export_excel_csv()
{
//Si hay variable POST de fecha es porque se está exportando desde la pantalla de selección de fecha y por defecto se eligen los Creados del día de la fecha
//seleccionada, sin embargo si no hay fecha entonces se recibe Type en GET porque vendrá desde el menú principal desplegable
		$filenameDate = date('Y-m-d');
		if (isset($_POST['fecha'])){
			$filenameDate = $_POST['fecha'];
			$query="SELECT * FROM t_storage WHERE estado='CRT' AND f_creacion < (NOW() - INTERVAL 10 HOUR) AND f_creacion LIKE '".$filenameDate."%' ORDER BY cliente, reason, in_modelo";
			unset($_POST['fecha']);
		}
		else{
			$type = $_GET["type"];

			if ($type === "all")
				$query="SELECT * FROM t_storage";
			else if ($type === "crt")
				//$query="SELECT * FROM t_storage WHERE estado='CRT' ORDER BY cliente, reason, in_modelo";
				//Se modifica para que aparezcan listados los CRT anteriores a 10 horas desde creación, de forma que alguien meta DR en GERP y aunque los técnicos
				//introduzcan nuevos DR al sistema, no aparecen listados (para no marear) hasta 10 horas después, teniendo "margen de maniobra"
				$query="SELECT * FROM t_storage WHERE estado='CRT' AND f_creacion < (NOW() - INTERVAL 10 HOUR) ORDER BY cliente, reason, in_modelo";
			else if ($type === "pnd")
				$query="SELECT * FROM t_storage WHERE estado='PND' ORDER BY rma,  f_realizacionGerp";
			else if ($type === "acp")
				$query="SELECT * FROM t_storage WHERE estado='ACP' ORDER BY f_recibido DESC, f_realizacionGerp DESC, rma ASC";
			else if ($type === "err")
				$query="SELECT * FROM t_storage WHERE estado='ERR' ORDER BY f_realizacionGerp DESC, rma ASC";
		}

		$result= mysql_query($query) or die(mysql_error());
		$objPHPExcel = new PHPExcel();
		$objPHPExcel->setActiveSheetIndex(0);
		$rowcount=1;
			$objPHPExcel->getActiveSheet()->getColumnDimension('A')->setAutoSize(true);
			$objPHPExcel->getActiveSheet()->getColumnDimension('B')->setAutoSize(true);
			$objPHPExcel->getActiveSheet()->getColumnDimension('C')->setAutoSize(true);
			$objPHPExcel->getActiveSheet()->getColumnDimension('D')->setAutoSize(true);
			$objPHPExcel->getActiveSheet()->getColumnDimension('E')->setAutoSize(true);
			$objPHPExcel->getActiveSheet()->getColumnDimension('F')->setAutoSize(true);
			$objPHPExcel->getActiveSheet()->getColumnDimension('G')->setAutoSize(true);
			$objPHPExcel->getActiveSheet()->getColumnDimension('H')->setAutoSize(true);
			$objPHPExcel->getActiveSheet()->getColumnDimension('I')->setAutoSize(true);
			$objPHPExcel->getActiveSheet()->getColumnDimension('J')->setAutoSize(true);
			$objPHPExcel->getActiveSheet()->getColumnDimension('K')->setAutoSize(true);
			$objPHPExcel->getActiveSheet()->getColumnDimension('L')->setAutoSize(true);
			$objPHPExcel->getActiveSheet()->getColumnDimension('M')->setAutoSize(true);
			$objPHPExcel->getActiveSheet()->getColumnDimension('N')->setAutoSize(true);
			$objPHPExcel->getActiveSheet()->getColumnDimension('O')->setAutoSize(true);
			$objPHPExcel->getActiveSheet()->getColumnDimension('P')->setAutoSize(true);
			$objPHPExcel->getActiveSheet()->getColumnDimension('Q')->setAutoSize(true);
			$objPHPExcel->getActiveSheet()->getColumnDimension('R')->setAutoSize(true);
			$objPHPExcel->getActiveSheet()->getColumnDimension('S')->setAutoSize(true);
			$objPHPExcel->getActiveSheet()->getColumnDimension('T')->setAutoSize(true);
			$objPHPExcel->getActiveSheet()->getColumnDimension('U')->setAutoSize(true);
			$objPHPExcel->getActiveSheet()->getColumnDimension('V')->setAutoSize(true);

		//Se escriben las cabeceras
		$objPHPExcel->getActiveSheet()->getStyle("A1:W1")->getFont()->setBold(true); //Primera fila en negrita
		$objPHPExcel->getActiveSheet()->SetCellValue('A'.$rowcount, "Cliente");
		$objPHPExcel->getActiveSheet()->SetCellValue('B'.$rowcount, "Comentario");
		 $objPHPExcel->getActiveSheet()->SetCellValue('C'.$rowcount, "RMA");
		 $objPHPExcel->getActiveSheet()->SetCellValue('D'.$rowcount, "MC");
		 $objPHPExcel->getActiveSheet()->SetCellValue('E'.$rowcount, "RNE");
		 $objPHPExcel->getActiveSheet()->SetCellValue('F'.$rowcount, "Teléfono");
		 $objPHPExcel->getActiveSheet()->SetCellValue('G'.$rowcount, "Calle");
		 $objPHPExcel->getActiveSheet()->SetCellValue('H'.$rowcount, "CP");
		 $objPHPExcel->getActiveSheet()->SetCellValue('I'.$rowcount, "Población");
		 $objPHPExcel->getActiveSheet()->SetCellValue('J'.$rowcount, "Provincia");
		 $objPHPExcel->getActiveSheet()->SetCellValue('K'.$rowcount, "Origen");
		 $objPHPExcel->getActiveSheet()->SetCellValue('L'.$rowcount, "Razón");
		 $objPHPExcel->getActiveSheet()->SetCellValue('M'.$rowcount, "Almacen entrada");
		 $objPHPExcel->getActiveSheet()->SetCellValue('N'.$rowcount, "Modelo entrada");
		 $objPHPExcel->getActiveSheet()->SetCellValue('O'.$rowcount, "SN entrada");
		 $objPHPExcel->getActiveSheet()->SetCellValue('P'.$rowcount, "IMEI entrada");
		 $objPHPExcel->getActiveSheet()->SetCellValue('Q'.$rowcount, "Almacén salida");
		 $objPHPExcel->getActiveSheet()->SetCellValue('R'.$rowcount, "Modelo salida");
		 $objPHPExcel->getActiveSheet()->SetCellValue('S'.$rowcount, "SN salida");
		 $objPHPExcel->getActiveSheet()->SetCellValue('T'.$rowcount, "IMEI salida");
		 $objPHPExcel->getActiveSheet()->SetCellValue('U'.$rowcount, "ID");
		 $objPHPExcel->getActiveSheet()->SetCellValue('V'.$rowcount, "F. Creacion");
		 $rowcount++;



		while($row = mysql_fetch_array($result)){
			 $objPHPExcel->getActiveSheet()->SetCellValue('A'.$rowcount, utf8_encode($row['cliente']));
			 $objPHPExcel->getActiveSheet()->SetCellValue('B'.$rowcount, utf8_encode($row['comentarios']));
			 $objPHPExcel->getActiveSheet()->SetCellValue('C'.$rowcount, $row['rma']);
			 $objPHPExcel->getActiveSheet()->SetCellValue('D'.$rowcount, $row['mc']);
			 $objPHPExcel->getActiveSheet()->SetCellValue('E'.$rowcount, $row['nref']);
			 $objPHPExcel->getActiveSheet()->SetCellValue('F'.$rowcount, $row['telefono']);
			 $objPHPExcel->getActiveSheet()->SetCellValue('G'.$rowcount, utf8_encode($row['calle']));
			 $objPHPExcel->getActiveSheet()->SetCellValue('H'.$rowcount, $row['cp']);
			 $objPHPExcel->getActiveSheet()->SetCellValue('I'.$rowcount, utf8_encode($row['poblacion']));
			 $objPHPExcel->getActiveSheet()->SetCellValue('J'.$rowcount, utf8_encode($row['provincia']));
			 $objPHPExcel->getActiveSheet()->setCellValueExplicit('K'.$rowcount, $row['origen']);
			 //Si hay part number se añade un "->" y se une a "DP3"
			 if ($row['reason'] == "DP3")
 				$partNumber = " -> " . $row['part_number_dp3'];
 			else {
 				$partNumber = "";
 			}
			 $objPHPExcel->getActiveSheet()->SetCellValue('L'.$rowcount, $row['reason'] . $partNumber);
			 $objPHPExcel->getActiveSheet()->SetCellValue('M'.$rowcount, $row['in_almacen']);
			 $objPHPExcel->getActiveSheet()->SetCellValue('N'.$rowcount, $row['in_modelo']);
			 $objPHPExcel->getActiveSheet()->SetCellValue('O'.$rowcount, $row['in_serial']);
			 $objPHPExcel->getActiveSheet()->setCellValueExplicit('P'.$rowcount, $row['in_imei'], PHPExcel_Cell_DataType::TYPE_STRING); //Se formatea la celda del IMEI
			 $objPHPExcel->getActiveSheet()->SetCellValue('Q'.$rowcount, $row['out_almacen']);
			 $objPHPExcel->getActiveSheet()->SetCellValue('R'.$rowcount, $row['out_modelo']);
			 $objPHPExcel->getActiveSheet()->SetCellValue('S'.$rowcount, $row['out_serial']);
			 $objPHPExcel->getActiveSheet()->setCellValueExplicit('T'.$rowcount, $row['out_imei'], PHPExcel_Cell_DataType::TYPE_STRING);
			 $objPHPExcel->getActiveSheet()->SetCellValue('U'.$rowcount, $row['ID']);
			 $objPHPExcel->getActiveSheet()->SetCellValue('V'.$rowcount, $row['f_creacion']);
			$rowcount++;
		}
		$fileName = "Exported_".$type."_".$filenameDate.".xls";
		header('Content-Type: application/vnd.ms-excel');
		header('Content-Disposition: attachment;filename="'.$fileName.'"');
		header('Cache-Control: max-age=0');
		$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel5');
		$objWriter->save('php://output');
}

export_excel_csv();
?>
